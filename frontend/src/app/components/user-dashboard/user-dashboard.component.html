<div class="dashboard">
  <!-- Tabs -->
  <nav class="tabs">
    <button [class.active]="activeTab === 'new'"
            (click)="activeTab = 'new'">Nueva Reserva</button>
    <button [class.active]="activeTab === 'upcoming'"
            (click)="activeTab = 'upcoming'">Reservas Futuras</button>
    <button [class.active]="activeTab === 'history'"
            (click)="activeTab = 'history'">Historial</button>
  </nav>

  <!-- Contenido -->
  <div class="tab-content">

    <!-- 1. NUEVA RESERVA -->
    <div *ngIf="activeTab === 'new'" class="tab-panel">
      <h2>Locales disponibles</h2>

      <div class="search-controls">
        <label for="date-select">Consultar Disponibilidad en Fecha:</label>
        <input type="date" id="date-select" [(ngModel)]="searchDate">
      </div>

      <div *ngFor="let l of locales" class="locale-card">
        <img [src]="l.imagen_url" [alt]="l.name"
             onerror="this.src='/assets/img/no-image.jpg'">
        <div class="info">
          <strong>{{ l.name }}</strong>
          <p>{{ l.description }}</p>
          <p>Capacidad: {{ l.capacity }}</p>
        </div>

        <button (click)="checkAvailability(l.id)">
          Ver Horarios Libres para {{ searchDate }}
        </button>

        <!-- Disponibilidad -->
        <div *ngIf="selectedLocaleId === l.id" class="availability-panel">
          <div *ngIf="loadingAvailability" class="loading">Cargando horarios...</div>

          <div *ngIf="availability && !loadingAvailability">
            <p *ngIf="availability.available_slots.length === 0">游뛂 No hay bloques libres este d칤a.</p>

            <ul class="slot-list">
              <li *ngFor="let block of availability.available_slots"
                  [class.selected-slot]="selectedBlock?.start_dt === block.start_dt"
                  (click)="selectBlock(block)">
                {{ block.start_dt | date:'shortTime' }} - {{ block.end_dt | date:'shortTime' }}
              </li>
            </ul>

            <!-- Formulario de reserva -->
            <div *ngIf="selectedBlock" class="reservation-form">
              <h4>Reservar Rango Personalizado</h4>
              <p class="selected-time">
                M치x. Rango: {{ selectedBlock.start_dt | date:'shortTime' }} -
                {{ selectedBlock.end_dt | date:'shortTime' }}
              </p>

              <div class="time-inputs">
                <label>Inicio
                  <input type="datetime-local" [(ngModel)]="reservationStart"
                         [min]="getDateTimeLocalString(selectedBlock.start_dt)"
                         [max]="getDateTimeLocalString(selectedBlock.end_dt)">
                </label>
                <label>Fin
                  <input type="datetime-local" [(ngModel)]="reservationEnd"
                         [min]="reservationStart"
                         [max]="getDateTimeLocalString(selectedBlock.end_dt)">
                </label>
              </div>

              <label>Motivo
                <textarea [(ngModel)]="motiveInput"
                          placeholder="Describe brevemente el motivo..."></textarea>
              </label>

              <button (click)="onReserve(l.id)"
                      [disabled]="!isReservationValid()">Solicitar Reserva</button>
              <button (click)="selectedBlock = null">Cancelar</button>

              <p *ngIf="!isReservationValid()" class="validation-message">
                El rango debe estar dentro del bloque y ser v치lido.
              </p>
            </div>
          </div>

          <details>
            <summary>Horarios Ocupados ({{ availability?.occupied_slots?.length || 0 }})</summary>
            <ul class="occupied-list">
              <li *ngFor="let slot of availability?.occupied_slots">
                {{ slot.start_dt | date:'shortTime' }} - {{ slot.end_dt | date:'shortTime' }}
                <span class="status-indicator"
                      [class.status-pending]="slot.status === 'pending'"
                      [class.status-approved]="slot.status === 'approved'">
                  {{ slot.status }}
                </span>
              </li>
            </ul>
          </details>
        </div>
      </div>
    </div>

    <!-- 2. RESERVAS FUTURAS -->
    <div *ngIf="activeTab === 'upcoming'" class="tab-panel">
      <h2>Pr칩ximas Reservas</h2>

      <div *ngIf="(upcoming$ | async)!.length === 0" class="empty">
        No tienes reservas futuras.
      </div>

      <div class="reservation-card"
           *ngFor="let r of upcoming$ | async">
        <img [src]="getLocaleImage(r.locale_id)"
             [alt]="getLocaleName(r.locale_id)"
             onerror="this.src='/assets/img/no-image.jpg'">
        <div class="info">
          <strong>{{ getLocaleName(r.locale_id) }}</strong>
          <p>{{ r.start_dt | date:'shortDate' }} 췅
             {{ r.start_dt | date:'shortTime' }} -
             {{ r.end_dt | date:'shortTime' }}</p>
          <!-- Badge din치mico -->
          <span class="status-badge"
                [class.approved]="r.status === 'approved'"
                [class.pending]="r.status === 'pending'"
                [class.rejected]="r.status === 'rejected'">
            {{ r.status | uppercase }}
          </span>
        </div>
        <button (click)="cancel(r.id)">Cancelar</button>
      </div>
    </div>

    <!-- 3. HISTORIAL -->
    <div *ngIf="activeTab === 'history'" class="tab-panel">
      <h2>Historial de Reservas</h2>

      <div *ngIf="(history$ | async)!.length === 0" class="empty">
        Sin reservas anteriores.
      </div>

      <div class="reservation-card"
           *ngFor="let r of history$ | async">
        <img [src]="getLocaleImage(r.locale_id)"
             [alt]="getLocaleName(r.locale_id)"
             onerror="this.src='/assets/img/no-image.jpg'">
        <div class="info">
          <strong>{{ getLocaleName(r.locale_id) }}</strong>
          <p>{{ r.start_dt | date:'shortDate' }} 췅
             {{ r.start_dt | date:'shortTime' }} -
             {{ r.end_dt | date:'shortTime' }}</p>
          <!-- Badge din치mico -->
          <span class="status-badge"
                [class.approved]="r.status === 'approved'"
                [class.cancelled]="r.status === 'cancelled'"
                [class.rejected]="r.status === 'rejected'">
            {{ r.status | uppercase }}
          </span>
        </div>
      </div>
    </div>

  </div>
</div>